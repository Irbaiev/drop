<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Offline Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { width: 100%; height: 100%; overflow: hidden; }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
  </style>
</head>
<body>
  <iframe id="game-frame" src="mirror\mirror-image-gaming.live.stake-engine.com\drop-the-boss\v10\index.__q_57679522.html?access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZXNzaW9uIjp7InBsYXllcklkIjoiZGVtbzp0b3BzcGluLXN0d2FsbGV0OjExMzU0MDc3IiwiZ2FtZUlkIjoidHMtdGctcGFwZXJwbGFuZSIsImlzUGxheUZvckZ1biI6dHJ1ZSwiY3VycmVuY3kiOiJVU0QiLCJmb3JjZUNvbmZpZyI6IiIsImlwQWRkcmVzcyI6Ijc4LjQwLjExNi4xMzYiLCJzdWJQYXJ0bmVySUQiOiIiLCJjYWxsQmFja1VSTCI6IiJ9fQ.LOsJIU1o3dul065zHwLrKXI4UPMoVcE1wfmwLwfjBKA&play_for_fun=true&language=en&currency=USD" allowfullscreen></iframe>
  
  <script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ sessionID —á–µ—Ä–µ–∑ GraphQL API stake.com
    async function getNewSessionFromStakeAPI(gameSlug = 'mirrorimage-drop-the-boss-trump') {
      try {
        console.log('[GAME] üîÑ –ó–∞–ø—Ä–æ—Å –Ω–æ–≤–æ–≥–æ sessionID —á–µ—Ä–µ–∑ GraphQL API...');
        console.log('[GAME] üìç –†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ:', window.navigator.incognito !== undefined ? '–≤–æ–∑–º–æ–∂–Ω–æ' : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
        
        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–ø—Ä–æ—Å–∞
        const fetchOptions = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-language': 'ru',
            'x-operation-name': 'StartThirdPartyDemoSession',
            'x-operation-type': 'query'
          },
          body: JSON.stringify({
            query: 'mutation StartThirdPartyDemoSession($slug: String!) { startThirdPartyDemoSession(slug: $slug) { config } }',
            variables: { slug: gameSlug }
          }),
          mode: 'cors',
          // –ü—Ä–æ–±—É–µ–º —Å credentials –≤ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ (–º–æ–∂–µ—Ç –ø–æ–º–æ—á—å)
          credentials: 'omit' // 'omit' - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º cookies, –Ω–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å CORS
        };
        
        console.log('[GAME] üîç –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ stake.com GraphQL API...');
        const response = await fetch('https://stake.com/_api/graphql', fetchOptions);
        
        console.log('[GAME] üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          headers: Object.fromEntries(response.headers.entries())
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('[GAME] ‚ùå HTTP –æ—à–∏–±–∫–∞:', {
            status: response.status,
            statusText: response.statusText,
            body: errorText.substring(0, 500)
          });
          
          // –ï—Å–ª–∏ CORS –æ—à–∏–±–∫–∞, –ø—Ä–æ–±—É–µ–º –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
          if (response.status === 0 || response.type === 'opaque') {
            console.warn('[GAME] ‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ –Ω–∞ CORS –æ—à–∏–±–∫—É. –ü—Ä–æ–±—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å...');
            const simpleResponse = await fetch('https://stake.com/_api/graphql', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                query: 'mutation StartThirdPartyDemoSession($slug: String!) { startThirdPartyDemoSession(slug: $slug) { config } }',
                variables: { slug: gameSlug }
              }),
              mode: 'cors'
            });
            
            if (!simpleResponse.ok) {
              throw new Error(`CORS/HTTP ${simpleResponse.status}: ${simpleResponse.statusText}`);
            }
            
            const simpleData = await simpleResponse.json();
            if (simpleData.errors) {
              throw new Error('GraphQL errors: ' + JSON.stringify(simpleData.errors));
            }
            
            const configUrl = simpleData.data?.startThirdPartyDemoSession?.config;
            if (!configUrl) {
              throw new Error('Config URL not found in response');
            }
            
            return parseConfigUrl(configUrl);
          }
          
          throw new Error(`HTTP ${response.status}: ${response.statusText}. Body: ${errorText.substring(0, 200)}`);
        }
        
        const data = await response.json();
        
        if (data.errors) {
          console.error('[GAME] ‚ùå GraphQL –æ—à–∏–±–∫–∏:', data.errors);
          throw new Error('GraphQL errors: ' + JSON.stringify(data.errors));
        }
        
        const configUrl = data.data?.startThirdPartyDemoSession?.config;
        if (!configUrl) {
          throw new Error('Config URL not found in response');
        }
        
        console.log('[GAME] ‚úÖ –ü–æ–ª—É—á–µ–Ω config URL:', configUrl);
        return parseConfigUrl(configUrl);
        
      } catch (error) {
        console.error('[GAME] ‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è sessionID —á–µ—Ä–µ–∑ API:', error);
        console.error('[GAME] üìã –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {
          name: error.name,
          message: error.message,
          stack: error.stack?.substring(0, 500)
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ CORS –æ—à–∏–±–∫–∞?
        if (error.message.includes('CORS') || error.message.includes('Failed to fetch') || error.name === 'TypeError') {
          console.warn('[GAME] ‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ –Ω–∞ CORS –æ—à–∏–±–∫—É. –í –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ —Ä–µ–∂–∏–º–µ stake.com –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã.');
          console.warn('[GAME] üí° –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä.');
        }
        
        throw error;
      }
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ config URL
    function parseConfigUrl(configUrl) {
      const url = new URL(configUrl);
      const sessionID = url.searchParams.get('sessionID');
      const rgsUrl = url.searchParams.get('rgs_url');
      const currency = url.searchParams.get('currency') || 'USD';
      const lang = url.searchParams.get('lang') || 'ru';
      
      if (!sessionID || !rgsUrl) {
        throw new Error('sessionID or rgs_url not found in config URL');
      }
      
      console.log('[GAME] ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ sessionID:', sessionID.substring(0, 20) + '...');
      console.log('[GAME] ‚úÖ RGS URL:', rgsUrl);
      
      return {
        sessionID,
        rgsUrl,
        currency,
        lang,
        fullUrl: configUrl
      };
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ JWT —Ç–æ–∫–µ–Ω–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º playerId
    async function generateNewAccessToken() {
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π playerId –Ω–∞ –æ—Å–Ω–æ–≤–µ timestamp –∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞
      const timestamp = Date.now();
      const random = Math.floor(Math.random() * 1000000);
      const playerId = `demo:topspin-stwallet:${timestamp}${random}`;
      
      // –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ payload (–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–∫–µ–Ω–∞)
      const payload = {
        session: {
          playerId: playerId,
          gameId: "ts-tg-paperplane",
          isPlayForFun: true,
          currency: "USD",
          forceConfig: "",
          ipAddress: "78.40.116.136",
          subPartnerID: "",
          callbackURL: ""
        }
      };
      
      // –ö–æ–¥–∏—Ä—É–µ–º header –∏ payload –≤ base64url
      const header = btoa(JSON.stringify({ alg: "HS256", typ: "JWT" }))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      const payloadEncoded = btoa(JSON.stringify(payload))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      
      const unsignedToken = `${header}.${payloadEncoded}`;
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (–¥–ª—è –¥–µ–º–æ)
      // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Ö–æ–¥: –±–µ—Ä–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å—å –∫–∞–∫ —à–∞–±–ª–æ–Ω
      // –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å —Å –ø–æ–º–æ—â—å—é Web Crypto API
      try {
        // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Web Crypto API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏
        const secretKey = 'stake-secret-key'; // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á
        const encoder = new TextEncoder();
        const keyData = encoder.encode(secretKey);
        const cryptoKey = await crypto.subtle.importKey(
          'raw',
          keyData,
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['sign']
        );
        const signature = await crypto.subtle.sign(
          'HMAC',
          cryptoKey,
          encoder.encode(unsignedToken)
        );
        const signatureBase64 = btoa(String.fromCharCode(...new Uint8Array(signature)))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        return `${unsignedToken}.${signatureBase64}`;
      } catch (e) {
        // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å—å –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
        // –≠—Ç–æ –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ, –Ω–æ –¥–ª—è –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
        console.warn('[GAME] ‚ö†Ô∏è Could not generate signature, using template:', e);
        const existingSignature = 'LOsJIU1o3dul065zHwLrKXI4UPMoVcE1wfmwLwfjBKA';
        return `${unsignedToken}.${existingSignature}`;
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ access_token –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function getOrCreateUserAccessToken() {
      const STORAGE_KEY = 'OFFLINE_USER_ACCESS_TOKEN';
      const STORAGE_PLAYER_ID_KEY = 'OFFLINE_USER_PLAYER_ID';
      
      try {
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω
        let accessToken = localStorage.getItem(STORAGE_KEY);
        let playerId = localStorage.getItem(STORAGE_PLAYER_ID_KEY);
        
        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–Ω—ã–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if (accessToken && playerId) {
          try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π (–º–æ–∂–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å)
            const payload = JSON.parse(atob(accessToken.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
            if (payload.session && payload.session.playerId === playerId) {
              console.log('[GAME] üîë –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π access_token –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', playerId.substring(0, 30) + '...');
              return { accessToken, playerId };
            }
          } catch (e) {
            console.warn('[GAME] ‚ö†Ô∏è –¢–æ–∫–µ–Ω –ø–æ–≤—Ä–µ–∂–¥–µ–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π:', e);
          }
        }
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        console.log('[GAME] üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ access_token –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π playerId –Ω–∞ –æ—Å–Ω–æ–≤–µ –±—Ä–∞—É–∑–µ—Ä–∞ (fingerprint)
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏—é: userAgent + language + timezone + screen resolution
        // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º Date.now() —á—Ç–æ–±—ã ID –±—ã–ª —Å—Ç–∞–±–∏–ª—å–Ω—ã–º –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const fingerprint = [
          navigator.userAgent,
          navigator.language,
          Intl.DateTimeFormat().resolvedOptions().timeZone,
          `${screen.width}x${screen.height}`,
          navigator.hardwareConcurrency || 'unknown',
          navigator.platform || 'unknown'
        ].join('|');
        
        // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ID –∏–∑ fingerprint (—Ö–µ—à)
        let hash = 0;
        for (let i = 0; i < fingerprint.length; i++) {
          const char = fingerprint.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32bit integer
        }
        const uniqueId = Math.abs(hash).toString(36);
        playerId = `demo:topspin-stwallet:${uniqueId}`;
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        const payload = {
          session: {
            playerId: playerId,
            gameId: "ts-tg-paperplane",
            isPlayForFun: true,
            currency: "USD",
            forceConfig: "",
            ipAddress: "78.40.116.136",
            subPartnerID: "",
            callbackURL: ""
          }
        };
        
        const header = btoa(JSON.stringify({ alg: "HS256", typ: "JWT" }))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        const payloadEncoded = btoa(JSON.stringify(payload))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        
        const unsignedToken = `${header}.${payloadEncoded}`;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å—å (–¥–ª—è –¥–µ–º–æ)
        const existingSignature = 'LOsJIU1o3dul065zHwLrKXI4UPMoVcE1wfmwLwfjBKA';
        accessToken = `${unsignedToken}.${existingSignature}`;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ playerId
        localStorage.setItem(STORAGE_KEY, accessToken);
        localStorage.setItem(STORAGE_PLAYER_ID_KEY, playerId);
        
        console.log('[GAME] ‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π access_token –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', playerId.substring(0, 30) + '...');
        return { accessToken, playerId };
        
      } catch (e) {
        console.error('[GAME] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å access_token:', e);
        // Fallback –Ω–∞ —Ö–∞—Ä–¥–∫–æ–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
        return {
          accessToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZXNzaW9uIjp7InBsYXllcklkIjoiZGVtbzp0b3BzcGluLXN0d2FsbGV0OjExMzU0MDc3IiwiZ2FtZUlkIjoidHMtdGctcGFwZXJwbGFuZSIsImlzUGxheUZvckZ1biI6dHJ1ZSwiY3VycmVuY3kiOiJVU0QiLCJmb3JjZUNvbmZpZyI6IiIsImlwQWRkcmVzcyI6Ijc4LjQwLjExNi4xMzYiLCJzdWJQYXJ0bmVySUQiOiIiLCJjYWxsQmFja1VSTCI6IiJ9fQ.LOsJIU1o3dul065zHwLrKXI4UPMoVcE1wfmwLwfjBKA',
          playerId: 'demo:topspin-stwallet:11354077'
        };
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ access_token (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏: resetUserToken())
    // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è! –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Ç–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    window.resetUserToken = function() {
      try {
        localStorage.removeItem('OFFLINE_USER_ACCESS_TOKEN');
        localStorage.removeItem('OFFLINE_USER_PLAYER_ID');
        localStorage.removeItem('OFFLINE_REAL_API_ACCESS_TOKEN'); // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–ª—é—á
        console.log('[GAME] üóëÔ∏è Access token —Å–±—Ä–æ—à–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ.');
        console.warn('[GAME] ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞!');
        location.reload();
      } catch (e) {
        console.error('[GAME] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Ç–æ–∫–µ–Ω–∞:', e);
      }
    };
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π access_token –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userToken = getOrCreateUserAccessToken();
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π sessionID –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const iframe = document.getElementById('game-frame');
    
    const SESSION_RETRY_KEY = 'OFFLINE_SESSION_FETCH_ATTEMPTS';
    const SESSION_OVERLAY_ID = 'offline-session-wait-overlay';
    const SESSION_RETRY_BASE_DELAY = 750;
    const SESSION_RETRY_MAX_DELAY = 15000;

    let sessionFetchAttempts = Number(sessionStorage.getItem(SESSION_RETRY_KEY)) || 0;
    let sessionFetchInProgress = false;
    let sessionRetryTimer = null;

    let handshakePayload = null;
    let handshakeRafId = null;
    let handshakeTimeoutId = null;
    let handshakeActive = false;
    let handshakeTargetOrigin = '*';

    let sessionOverlayRefs = null;

    function storeSessionAttemptCount(value) {
      sessionFetchAttempts = value;
      try {
        sessionStorage.setItem(SESSION_RETRY_KEY, String(value));
      } catch (_) {}
    }

    function resetSessionAttemptCount() {
      storeSessionAttemptCount(0);
    }

    function incrementSessionAttemptCount() {
      const next = sessionFetchAttempts + 1;
      storeSessionAttemptCount(next);
      return next;
    }

    function computeRetryDelay(attempt) {
      const exponent = Math.min(attempt, 8);
      const delay = SESSION_RETRY_BASE_DELAY * Math.pow(1.8, exponent);
      return Math.min(SESSION_RETRY_MAX_DELAY, Math.max(SESSION_RETRY_BASE_DELAY, delay));
    }

    function ensureSessionOverlay() {
      if (sessionOverlayRefs) return sessionOverlayRefs;

      const overlay = document.createElement('div');
      overlay.id = SESSION_OVERLAY_ID;
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.display = 'none';
      overlay.style.background = '#000';
      overlay.style.zIndex = '9999';

      document.body.appendChild(overlay);

      sessionOverlayRefs = { overlay };
      return sessionOverlayRefs;
    }

    function showSessionOverlay() {}

    function hideSessionOverlay() {}

    function stopScheduledRetry() {
      if (sessionRetryTimer) {
        clearTimeout(sessionRetryTimer);
        sessionRetryTimer = null;
      }
    }

    function stopSessionHandshake(reason) {
      if (handshakeRafId !== null) {
        cancelAnimationFrame(handshakeRafId);
        handshakeRafId = null;
      }
      if (handshakeTimeoutId) {
        clearTimeout(handshakeTimeoutId);
        handshakeTimeoutId = null;
      }
      if (handshakeActive && reason) {
        console.log('[GAME] ü§ù Handshake –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', reason);
      }
      handshakeActive = false;
    }

    function beginSessionHandshake(targetOrigin = '*') {
      if (!handshakePayload || !iframe.contentWindow) {
        return;
      }

      stopSessionHandshake();
      handshakeActive = true;
      handshakeTargetOrigin = targetOrigin || '*';
      const startedAt = performance.now();
      const MAX_HANDSHAKE_DURATION = 8000;

      const pump = () => {
        if (!handshakeActive) {
          return;
        }
        if (performance.now() - startedAt > MAX_HANDSHAKE_DURATION) {
          console.warn('[GAME] ‚è±Ô∏è Handshake timeout ‚Äî –æ–∂–∏–¥–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –æ—Ç iframe');
          stopSessionHandshake();
          return;
        }
        try {
          iframe.contentWindow.postMessage(handshakePayload, handshakeTargetOrigin);
        } catch (err) {
          console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –≤ iframe:', err);
        }
        handshakeRafId = requestAnimationFrame(pump);
      };

      handshakeTimeoutId = setTimeout(() => {
        if (!handshakeActive) return;
        console.warn('[GAME] ‚è±Ô∏è Handshake –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É');
        stopSessionHandshake();
      }, MAX_HANDSHAKE_DURATION + 2000);

      pump();
    }

    function encodeSessionConfig(config) {
      try {
        const json = JSON.stringify(config);
        const encoder = new TextEncoder();
        const bytes = encoder.encode(json);
        let binary = '';
        bytes.forEach(byte => {
          binary += String.fromCharCode(byte);
        });
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      } catch (error) {
        console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è hash:', error);
        return '';
      }
    }

    function handleSessionFailure(error) {
      const attemptNumber = incrementSessionAttemptCount();
      const delay = computeRetryDelay(attemptNumber);
      const nextAttempt = attemptNumber + 1;
      console.warn(`[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å sessionID (–ø–æ–ø—ã—Ç–∫–∞ ${attemptNumber}). –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ ${delay} –º—Å`, error);
      showSessionOverlay({
        mode: 'error',
        error,
        attempt: attemptNumber,
        nextAttempt,
        nextDelayMs: delay
      });
      stopScheduledRetry();
      sessionRetryTimer = setTimeout(() => {
        sessionRetryTimer = null;
        attemptSessionFetch();
      }, delay);
    }

    function handleHandshakeMessage(event) {
      if (!iframe.contentWindow || event.source !== iframe.contentWindow) {
        return;
      }
      const type = event.data && event.data.type;
      if (type === 'IFRAME_READY' || type === 'IFRAME_NEEDS_SESSION') {
        console.log('[GAME] ü§ù Iframe –∑–∞–ø—Ä–æ—Å–∏–ª –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏:', type);
        const origin = event.origin && event.origin !== 'null' ? event.origin : '*';
        beginSessionHandshake(origin);
      } else if (type === 'SESSION_APPLIED') {
        console.log('[GAME] ‚úÖ Iframe –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–ª—É—á–µ–Ω–∏–µ sessionID');
        stopSessionHandshake('acknowledged');
        hideSessionOverlay();
      }
    }

    window.addEventListener('message', handleHandshakeMessage, false);

    function attemptSessionFetch(options = {}) {
      if (sessionFetchInProgress) {
        return;
      }
      stopScheduledRetry();
      sessionFetchInProgress = true;
      const currentAttempt = sessionFetchAttempts + 1;
      showSessionOverlay({
        mode: 'loading',
        attempt: currentAttempt
      });
      getNewSessionFromStakeAPI().then(sessionData => {
        sessionFetchInProgress = false;
        resetSessionAttemptCount();
        hideSessionOverlay();
        handleSessionSuccess(sessionData);
      }).catch(error => {
        sessionFetchInProgress = false;
        handleSessionFailure(error);
      });
    }

    // –û—á–∏—â–∞–µ–º –∞–¥—Ä–µ—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    try {
      const parentUrl = new URL(window.location.href);
      const paramsToStrip = ['access_token', 'play_for_fun', 'language', 'currency', 'sessionID', 'rgs_url', '_t'];
      let stripped = false;
      paramsToStrip.forEach(param => {
        if (parentUrl.searchParams.has(param)) {
          parentUrl.searchParams.delete(param);
          stripped = true;
        }
      });
      if (stripped) {
        const cleanSearch = parentUrl.searchParams.toString();
        const cleanUrl = parentUrl.pathname + (cleanSearch ? '?' + cleanSearch : '');
        window.history.replaceState({}, '', cleanUrl);
        console.log('[GAME] üßπ –ê–¥—Ä–µ—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –æ—á–∏—â–µ–Ω–∞ –æ—Ç —Å–ª—É–∂–µ–±–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤');
      }
    } catch (e) {
      console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∞–¥—Ä–µ—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É:', e);
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º iframe —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º access_token
    const currentSrc = iframe.src;
    const url = new URL(currentSrc, window.location.href);
    url.searchParams.set('access_token', userToken.accessToken);
    iframe.src = url.toString();
    
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π sessionID –∏–∑ URL —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    try {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('sessionID')) {
        urlParams.delete('sessionID');
        urlParams.delete('rgs_url');
        const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newUrl);
        console.log('[GAME] üóëÔ∏è –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π sessionID –∏–∑ URL —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
      }
    } catch (e) {
      console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å URL:', e);
    }
    
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π sessionID –∏–∑ localStorage –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º –Ω–æ–≤–æ–≥–æ
    try {
      localStorage.removeItem('LAST_SESSION_ID');
      localStorage.removeItem('LAST_RGS_URL');
      console.log('[GAME] üóëÔ∏è –û—á–∏—â–µ–Ω —Å—Ç–∞—Ä—ã–π sessionID –∏–∑ localStorage');
    } catch (e) {
      console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å localStorage:', e);
    }
    
    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π sessionID —á–µ—Ä–µ–∑ GraphQL API (–ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π)
    function handleSessionSuccess(sessionData) {
      if (!sessionData || !sessionData.sessionID || !sessionData.rgsUrl) {
        console.error('[GAME] ‚ùå –ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ sessionData:', sessionData);
        handleSessionFailure(new Error('Invalid session data'));
        return;
      }

      console.log('[GAME] ‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π sessionID!');
      stopSessionHandshake('refresh-before-reload');
      try {
        sessionStorage.removeItem(SESSION_RETRY_KEY);
      } catch (_) {}

      const configUrl = new URL(sessionData.fullUrl);
      let pathname = configUrl.pathname;

      if (pathname.endsWith('/')) {
        pathname = pathname.slice(0, -1);
      }

      let gameFile = '';
      if (pathname.match(/\/v\d+$/)) {
        const versionMatch = pathname.match(/\/(v\d+)$/);
        if (versionMatch) {
          pathname = pathname.replace(/\/v\d+$/, '/v10');
          gameFile = 'index.__q_57679522.html';
        } else {
          gameFile = 'index.html';
        }
      } else {
        const pathParts = pathname.split('/');
        gameFile = pathParts[pathParts.length - 1] || 'index.html';
        pathname = pathParts.slice(0, -1).join('/');
      }

      const baseUrl = `mirror/${configUrl.hostname}${pathname}/${gameFile}`;
      const params = new URLSearchParams(configUrl.search);
      const originalConfigUrlParams = new URLSearchParams(configUrl.search);

      params.set('access_token', userToken.accessToken);
      params.set('sessionID', sessionData.sessionID);
      params.set('rgs_url', sessionData.rgsUrl);
      params.set('_t', Date.now().toString());

      if (!params.has('lang') && sessionData.lang) {
        params.set('lang', sessionData.lang);
      }
      if (!params.has('currency') && sessionData.currency) {
        params.set('currency', sessionData.currency);
      }
      if (originalConfigUrlParams.has('device')) params.set('device', originalConfigUrlParams.get('device'));
      if (originalConfigUrlParams.has('social')) params.set('social', originalConfigUrlParams.get('social'));
      if (originalConfigUrlParams.has('demo')) params.set('demo', originalConfigUrlParams.get('demo'));

      const sessionContext = {
        sessionID: sessionData.sessionID,
        rgsUrl: sessionData.rgsUrl,
        accessToken: userToken.accessToken,
        currency: params.get('currency') || 'USD',
        lang: params.get('lang') || 'ru',
        device: params.get('device') || 'desktop',
        social: params.get('social') || 'false',
        demo: params.get('demo') || 'true'
      };

      const encodedConfig = encodeSessionConfig(sessionContext);
      const hashPart = encodedConfig ? `#cfg=${encodedConfig}` : '';
      const finalUrl = `${baseUrl}?${params.toString()}${hashPart}`;

      console.log('[GAME] üîÑ –û–±–Ω–æ–≤–ª—è—é iframe —Å –Ω–æ–≤—ã–º sessionID...');
      console.log('[GAME] üìÅ –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É:', baseUrl);
      console.log('[GAME] üîë sessionID –≤ URL:', params.get('sessionID') ? params.get('sessionID').substring(0, 20) + '...' : '–û–¢–°–£–¢–°–¢–í–£–ï–¢!');
      console.log('[GAME] üåê –ü–æ–ª–Ω—ã–π URL iframe:', finalUrl);

      try {
        const parentUrl = new URL(window.location.href);
        const allowedParams = ['sessionID', 'rgs_url', 'lang', 'currency', 'device', 'social', 'demo'];
        let parentUpdated = false;
        allowedParams.forEach(key => {
          const value = params.get(key);
          if (value !== null && value !== undefined) {
            if (parentUrl.searchParams.get(key) !== value) {
              parentUrl.searchParams.set(key, value);
              parentUpdated = true;
            }
          } else if (parentUrl.searchParams.has(key)) {
            parentUrl.searchParams.delete(key);
            parentUpdated = true;
          }
        });
        if (parentUpdated) {
          const cleanParentSearch = parentUrl.searchParams.toString();
          const cleanParentUrl = parentUrl.pathname + (cleanParentSearch ? '?' + cleanParentSearch : '');
          window.history.replaceState({}, '', cleanParentUrl);
          console.log('[GAME] üîó –ê–¥—Ä–µ—Å —Ä–æ–¥–∏—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—ë–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Å–µ—Å—Å–∏–∏');
        }
      } catch (e) {
        console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∞–¥—Ä–µ—Å —Ä–æ–¥–∏—Ç–µ–ª—è:', e);
      }

      window.__OFFLINE_SESSION_DATA = {
        ...sessionContext,
        hash: encodedConfig
      };

      try {
        localStorage.setItem('LAST_SESSION_ID', sessionData.sessionID);
        localStorage.setItem('LAST_RGS_URL', sessionData.rgsUrl);
        localStorage.setItem('OFFLINE_REAL_API_SESSION_ID', sessionData.sessionID);
        const normalizedBase = sessionData.rgsUrl.startsWith('http') ? sessionData.rgsUrl : `https://${sessionData.rgsUrl}`;
        localStorage.setItem('OFFLINE_REAL_API_URL', normalizedBase.replace(/\/+$/, ''));
        localStorage.setItem('OFFLINE_REAL_API_CURRENCY', sessionContext.currency);
        console.log('[GAME] üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage –ü–ï–†–ï–î –∑–∞–≥—Ä—É–∑–∫–æ–π iframe:', {
          sessionID: sessionData.sessionID.substring(0, 20) + '...',
          rgsUrl: sessionData.rgsUrl
        });
      } catch (e) {
        console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage:', e);
      }

      handshakePayload = {
        type: 'SET_SESSION_ID',
        sessionID: sessionData.sessionID,
        rgsUrl: sessionData.rgsUrl,
        accessToken: userToken.accessToken,
        force: true,
        lang: sessionContext.lang,
        currency: sessionContext.currency,
        device: sessionContext.device,
        social: sessionContext.social,
        demo: sessionContext.demo,
        hash: encodedConfig || null,
        timestamp: Date.now()
      };

      stopSessionHandshake('before-reassign-src');

      const kickstartHandshake = () => {
        if (!handshakePayload) return;
        beginSessionHandshake('*');
      };

      if (iframe.src) {
        iframe.src = '';
        setTimeout(() => {
          iframe.src = finalUrl;
          console.log('[GAME] ‚úÖ Iframe src –æ–±–Ω–æ–≤–ª–µ–Ω —Å –Ω–æ–≤—ã–º sessionID');
        }, 10);
      } else {
        iframe.src = finalUrl;
        console.log('[GAME] ‚úÖ Iframe src —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å –Ω–æ–≤—ã–º sessionID');
      }

      iframe.addEventListener('load', function onIframeLoad() {
        iframe.removeEventListener('load', onIframeLoad);
        console.log('[GAME] üì• Iframe –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º handshake...');
        setTimeout(kickstartHandshake, 200);
      }, { once: true });

      setTimeout(kickstartHandshake, 600);
    }

    attemptSessionFetch();
    
    function resizeIframe() {
      iframe.style.width = window.innerWidth + 'px';
      iframe.style.height = window.innerHeight + 'px';
    }
    
    window.addEventListener('resize', resizeIframe);
    window.addEventListener('load', resizeIframe);
    resizeIframe();
  </script>
</body>
</html>
