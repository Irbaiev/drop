<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Offline Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { width: 100%; height: 100%; overflow: hidden; }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
  </style>
</head>
<body>
  <iframe id="game-frame" src="about:blank" allowfullscreen></iframe>
  
  <script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ sessionID —á–µ—Ä–µ–∑ GraphQL API stake.com
    async function getNewSessionFromStakeAPI(gameSlug = 'mirrorimage-drop-the-boss-trump') {
      try {
        console.log('[GAME] üîÑ –ó–∞–ø—Ä–æ—Å –Ω–æ–≤–æ–≥–æ sessionID —á–µ—Ä–µ–∑ GraphQL API...');
        console.log('[GAME] üìç –†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ:', window.navigator.incognito !== undefined ? '–≤–æ–∑–º–æ–∂–Ω–æ' : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
        
        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–ø—Ä–æ—Å–∞
        const fetchOptions = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-language': 'ru',
            'x-operation-name': 'StartThirdPartyDemoSession',
            'x-operation-type': 'query',
            'Origin': 'https://stake.com',
            'Referer': 'https://stake.com/'
          },
          body: JSON.stringify({
            query: 'mutation StartThirdPartyDemoSession($slug: String!) { startThirdPartyDemoSession(slug: $slug) { config } }',
            variables: { slug: gameSlug }
          }),
          mode: 'cors',
          // –ü—Ä–æ–±—É–µ–º —Å credentials –≤ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ (–º–æ–∂–µ—Ç –ø–æ–º–æ—á—å)
          credentials: 'omit' // 'omit' - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º cookies, –Ω–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å CORS
        };
        
        console.log('[GAME] üîç –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ stake.com GraphQL API...');
        const response = await fetch('https://stake.com/_api/graphql', fetchOptions);
        
        console.log('[GAME] üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          headers: Object.fromEntries(response.headers.entries())
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('[GAME] ‚ùå HTTP –æ—à–∏–±–∫–∞:', {
            status: response.status,
            statusText: response.statusText,
            body: errorText.substring(0, 500)
          });
          
          // –ï—Å–ª–∏ CORS –æ—à–∏–±–∫–∞, –ø—Ä–æ–±—É–µ–º –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
          if (response.status === 0 || response.type === 'opaque') {
            console.warn('[GAME] ‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ –Ω–∞ CORS –æ—à–∏–±–∫—É. –ü—Ä–æ–±—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å...');
            const simpleResponse = await fetch('https://stake.com/_api/graphql', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                query: 'mutation StartThirdPartyDemoSession($slug: String!) { startThirdPartyDemoSession(slug: $slug) { config } }',
                variables: { slug: gameSlug }
              }),
              mode: 'cors'
            });
            
            if (!simpleResponse.ok) {
              throw new Error(`CORS/HTTP ${simpleResponse.status}: ${simpleResponse.statusText}`);
            }
            
            const simpleData = await simpleResponse.json();
            if (simpleData.errors) {
              throw new Error('GraphQL errors: ' + JSON.stringify(simpleData.errors));
            }
            
            const configUrl = simpleData.data?.startThirdPartyDemoSession?.config;
            if (!configUrl) {
              throw new Error('Config URL not found in response');
            }
            
            return parseConfigUrl(configUrl);
          }
          
          throw new Error(`HTTP ${response.status}: ${response.statusText}. Body: ${errorText.substring(0, 200)}`);
        }
        
        const data = await response.json();
        
        if (data.errors) {
          console.error('[GAME] ‚ùå GraphQL –æ—à–∏–±–∫–∏:', data.errors);
          throw new Error('GraphQL errors: ' + JSON.stringify(data.errors));
        }
        
        const configUrl = data.data?.startThirdPartyDemoSession?.config;
        if (!configUrl) {
          throw new Error('Config URL not found in response');
        }
        
        console.log('[GAME] ‚úÖ –ü–æ–ª—É—á–µ–Ω config URL:', configUrl);
        return parseConfigUrl(configUrl);
        
      } catch (error) {
        console.error('[GAME] ‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è sessionID —á–µ—Ä–µ–∑ API:', error);
        console.error('[GAME] üìã –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {
          name: error.name,
          message: error.message,
          stack: error.stack?.substring(0, 500)
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ CORS –æ—à–∏–±–∫–∞?
        if (error.message.includes('CORS') || error.message.includes('Failed to fetch') || error.name === 'TypeError') {
          console.warn('[GAME] ‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ –Ω–∞ CORS –æ—à–∏–±–∫—É. –í –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ —Ä–µ–∂–∏–º–µ stake.com –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã.');
          console.warn('[GAME] üí° –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä.');
        }
        
        throw error;
      }
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ config URL
    function parseConfigUrl(configUrl) {
      const url = new URL(configUrl);
      const sessionID = url.searchParams.get('sessionID');
      const rgsUrl = url.searchParams.get('rgs_url');
      const currency = url.searchParams.get('currency') || 'USD';
      const lang = url.searchParams.get('lang') || 'ru';
      
      if (!sessionID || !rgsUrl) {
        throw new Error('sessionID or rgs_url not found in config URL');
      }
      
      console.log('[GAME] ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ sessionID:', sessionID.substring(0, 20) + '...');
      console.log('[GAME] ‚úÖ RGS URL:', rgsUrl);
      
      return {
        sessionID,
        rgsUrl,
        currency,
        lang,
        fullUrl: configUrl
      };
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ JWT —Ç–æ–∫–µ–Ω–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º playerId
    async function generateNewAccessToken() {
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π playerId –Ω–∞ –æ—Å–Ω–æ–≤–µ timestamp –∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞
      const timestamp = Date.now();
      const random = Math.floor(Math.random() * 1000000);
      const playerId = `demo:topspin-stwallet:${timestamp}${random}`;
      
      // –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ payload (–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–∫–µ–Ω–∞)
      const payload = {
        session: {
          playerId: playerId,
          gameId: "ts-tg-paperplane",
          isPlayForFun: true,
          currency: "USD",
          forceConfig: "",
          ipAddress: "78.40.116.136",
          subPartnerID: "",
          callbackURL: ""
        }
      };
      
      // –ö–æ–¥–∏—Ä—É–µ–º header –∏ payload –≤ base64url
      const header = btoa(JSON.stringify({ alg: "HS256", typ: "JWT" }))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      const payloadEncoded = btoa(JSON.stringify(payload))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      
      const unsignedToken = `${header}.${payloadEncoded}`;
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (–¥–ª—è –¥–µ–º–æ)
      // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Ö–æ–¥: –±–µ—Ä–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å—å –∫–∞–∫ —à–∞–±–ª–æ–Ω
      // –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å—å —Å –ø–æ–º–æ—â—å—é Web Crypto API
      try {
        // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Web Crypto API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏
        const secretKey = 'stake-secret-key'; // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á
        const encoder = new TextEncoder();
        const keyData = encoder.encode(secretKey);
        const cryptoKey = await crypto.subtle.importKey(
          'raw',
          keyData,
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['sign']
        );
        const signature = await crypto.subtle.sign(
          'HMAC',
          cryptoKey,
          encoder.encode(unsignedToken)
        );
        const signatureBase64 = btoa(String.fromCharCode(...new Uint8Array(signature)))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        return `${unsignedToken}.${signatureBase64}`;
      } catch (e) {
        // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å—å –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
        // –≠—Ç–æ –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ, –Ω–æ –¥–ª—è –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
        console.warn('[GAME] ‚ö†Ô∏è Could not generate signature, using template:', e);
        const existingSignature = 'LOsJIU1o3dul065zHwLrKXI4UPMoVcE1wfmwLwfjBKA';
        return `${unsignedToken}.${existingSignature}`;
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ access_token –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function getOrCreateUserAccessToken() {
      const STORAGE_KEY = 'OFFLINE_USER_ACCESS_TOKEN';
      const STORAGE_PLAYER_ID_KEY = 'OFFLINE_USER_PLAYER_ID';
      
      try {
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω
        let accessToken = localStorage.getItem(STORAGE_KEY);
        let playerId = localStorage.getItem(STORAGE_PLAYER_ID_KEY);
        
        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–Ω—ã–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if (accessToken && playerId) {
          try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π (–º–æ–∂–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å)
            const payload = JSON.parse(atob(accessToken.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
            if (payload.session && payload.session.playerId === playerId) {
              console.log('[GAME] üîë –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π access_token –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', playerId.substring(0, 30) + '...');
              return { accessToken, playerId };
            }
          } catch (e) {
            console.warn('[GAME] ‚ö†Ô∏è –¢–æ–∫–µ–Ω –ø–æ–≤—Ä–µ–∂–¥–µ–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π:', e);
          }
        }
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        console.log('[GAME] üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ access_token –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π playerId –Ω–∞ –æ—Å–Ω–æ–≤–µ –±—Ä–∞—É–∑–µ—Ä–∞ (fingerprint)
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏—é: userAgent + language + timezone + screen resolution
        // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º Date.now() —á—Ç–æ–±—ã ID –±—ã–ª —Å—Ç–∞–±–∏–ª—å–Ω—ã–º –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const fingerprint = [
          navigator.userAgent,
          navigator.language,
          Intl.DateTimeFormat().resolvedOptions().timeZone,
          `${screen.width}x${screen.height}`,
          navigator.hardwareConcurrency || 'unknown',
          navigator.platform || 'unknown'
        ].join('|');
        
        // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π ID –∏–∑ fingerprint (—Ö–µ—à)
        let hash = 0;
        for (let i = 0; i < fingerprint.length; i++) {
          const char = fingerprint.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32bit integer
        }
        const uniqueId = Math.abs(hash).toString(36);
        playerId = `demo:topspin-stwallet:${uniqueId}`;
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        const payload = {
          session: {
            playerId: playerId,
            gameId: "ts-tg-paperplane",
            isPlayForFun: true,
            currency: "USD",
            forceConfig: "",
            ipAddress: "78.40.116.136",
            subPartnerID: "",
            callbackURL: ""
          }
        };
        
        const header = btoa(JSON.stringify({ alg: "HS256", typ: "JWT" }))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        const payloadEncoded = btoa(JSON.stringify(payload))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        
        const unsignedToken = `${header}.${payloadEncoded}`;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å—å (–¥–ª—è –¥–µ–º–æ)
        const existingSignature = 'LOsJIU1o3dul065zHwLrKXI4UPMoVcE1wfmwLwfjBKA';
        accessToken = `${unsignedToken}.${existingSignature}`;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ playerId
        localStorage.setItem(STORAGE_KEY, accessToken);
        localStorage.setItem(STORAGE_PLAYER_ID_KEY, playerId);
        
        console.log('[GAME] ‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π access_token –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', playerId.substring(0, 30) + '...');
        return { accessToken, playerId };
        
      } catch (e) {
        console.error('[GAME] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å access_token:', e);
        // Fallback –Ω–∞ —Ö–∞—Ä–¥–∫–æ–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
        return {
          accessToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZXNzaW9uIjp7InBsYXllcklkIjoiZGVtbzp0b3BzcGluLXN0d2FsbGV0OjExMzU0MDc3IiwiZ2FtZUlkIjoidHMtdGctcGFwZXJwbGFuZSIsImlzUGxheUZvckZ1biI6dHJ1ZSwiY3VycmVuY3kiOiJVU0QiLCJmb3JjZUNvbmZpZyI6IiIsImlwQWRkcmVzcyI6Ijc4LjQwLjExNi4xMzYiLCJzdWJQYXJ0bmVySUQiOiIiLCJjYWxsQmFja1VSTCI6IiJ9fQ.LOsJIU1o3dul065zHwLrKXI4UPMoVcE1wfmwLwfjBKA',
          playerId: 'demo:topspin-stwallet:11354077'
        };
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ access_token (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏: resetUserToken())
    // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è! –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Ç–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    window.resetUserToken = function() {
      try {
        localStorage.removeItem('OFFLINE_USER_ACCESS_TOKEN');
        localStorage.removeItem('OFFLINE_USER_PLAYER_ID');
        localStorage.removeItem('OFFLINE_REAL_API_ACCESS_TOKEN'); // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–ª—é—á
        console.log('[GAME] üóëÔ∏è Access token —Å–±—Ä–æ—à–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ.');
        console.warn('[GAME] ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞!');
        location.reload();
      } catch (e) {
        console.error('[GAME] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Ç–æ–∫–µ–Ω–∞:', e);
      }
    };
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π access_token –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userToken = getOrCreateUserAccessToken();
    
    const iframe = document.getElementById('game-frame');

    function buildSessionFromConfig(configUrlString, sourceLabel = 'API session') {
      try {
        const configUrl = new URL(configUrlString, window.location.origin);
        let pathname = configUrl.pathname;
        if (pathname.endsWith('/')) {
          pathname = pathname.slice(0, -1);
        }

        let gameFile = '';
        if (pathname.match(/\/v\d+$/)) {
          const versionMatch = pathname.match(/\/(v\d+)$/);
          if (versionMatch) {
            pathname = pathname.replace(/\/v\d+$/, '/v10');
            gameFile = 'index.__q_57679522.html';
          } else {
            gameFile = 'index.html';
          }
        } else {
          const pathParts = pathname.split('/');
          gameFile = pathParts[pathParts.length - 1] || 'index.html';
          pathname = pathParts.slice(0, -1).join('/');
        }

        const sessionID = configUrl.searchParams.get('sessionID');
        const rgsUrl = configUrl.searchParams.get('rgs_url') || 'rgs.twist-rgs.com';
        const baseUrl = `mirror/${configUrl.hostname}${pathname}/${gameFile}`;

        const params = new URLSearchParams(configUrl.search);
        params.set('access_token', userToken.accessToken);
        if (sessionID) params.set('sessionID', sessionID);
        if (rgsUrl) params.set('rgs_url', rgsUrl);
        params.set('_t', Date.now().toString());

        const finalUrl = `${baseUrl}?${params.toString()}`;

        return {
          finalUrl,
          baseUrl,
          sessionID,
          rgsUrl,
          currency: configUrl.searchParams.get('currency') || 'USD',
          lang: configUrl.searchParams.get('lang') || 'en',
          configUrlString,
          source: sourceLabel
        };
      } catch (e) {
        console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –∏–∑ URL:', configUrlString, e);
        return null;
      }
    }

    function normalizeRgsUrl(rgsUrl) {
      if (!rgsUrl) return '';
      if (/^https?:\/\//i.test(rgsUrl)) {
        return rgsUrl.replace(/\/+$/, '');
      }
      return `https://${rgsUrl}`.replace(/\/+$/, '');
    }

    function prepareIframeWithSession(sessionInfo) {
      if (!sessionInfo || !sessionInfo.sessionID) {
        console.warn('[GAME] ‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é: sessionID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', sessionInfo);
        return false;
      }

      const { finalUrl, baseUrl, sessionID, rgsUrl, source = 'session' } = sessionInfo;
      const resolvedFinalUrl = finalUrl.startsWith('http')
        ? finalUrl
        : new URL(finalUrl, window.location.href).toString();

      console.log(`[GAME] üîÑ ${source}: –æ–±–Ω–æ–≤–ª—è—é iframe —Å sessionID`);
      if (baseUrl) {
        console.log('[GAME] üìÅ –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É:', baseUrl);
      }
      console.log('[GAME] üîë sessionID –≤ URL:', sessionID.substring(0, 20) + '...');
      console.log('[GAME] üåê –ü–æ–ª–Ω—ã–π URL iframe:', resolvedFinalUrl);

      try {
        localStorage.setItem('LAST_SESSION_ID', sessionID);
        if (rgsUrl) {
          localStorage.setItem('LAST_RGS_URL', rgsUrl);
          localStorage.setItem('OFFLINE_REAL_API_URL', normalizeRgsUrl(rgsUrl));
        }
        localStorage.setItem('OFFLINE_REAL_API_SESSION_ID', sessionID);
        localStorage.setItem('LAST_IFRAME_URL', finalUrl);
        if (sessionInfo.configUrlString) {
          localStorage.setItem('LAST_CONFIG_URL', sessionInfo.configUrlString);
        }
      } catch (storageError) {
        console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –≤ localStorage:', storageError);
      }

      try {
        const parentParams = new URLSearchParams(window.location.search);
        parentParams.set('sessionID', sessionID);
        if (rgsUrl) parentParams.set('rgs_url', rgsUrl);
        const newParentUrl = window.location.pathname + '?' + parentParams.toString();
        if (newParentUrl !== window.location.pathname + window.location.search) {
          window.history.replaceState({}, '', newParentUrl);
        }
      } catch (urlError) {
        console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å URL —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', urlError);
      }

      let postMessageAttempts = 0;
      const maxAttempts = 10;
      const messagePayload = {
        type: 'SET_SESSION_ID',
        sessionID,
        rgsUrl,
        accessToken: userToken.accessToken,
        force: true
      };

      function sendSessionIDMessage() {
        if (iframe.contentWindow) {
          iframe.contentWindow.postMessage(messagePayload, '*');
          console.log(`[GAME] üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω sessionID –≤ iframe (${source}, –ø–æ–ø—ã—Ç–∫–∞ ${postMessageAttempts + 1}/${maxAttempts})`);
          postMessageAttempts += 1;
          if (postMessageAttempts < maxAttempts) {
            setTimeout(sendSessionIDMessage, 200);
          } else {
            console.log(`[GAME] ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ postMessage (${maxAttempts} –ø–æ–ø—ã—Ç–æ–∫)`);
          }
        } else if (postMessageAttempts < maxAttempts) {
          postMessageAttempts += 1;
          setTimeout(sendSessionIDMessage, 200);
        }
      }

      const loadHandler = () => {
        iframe.removeEventListener('load', loadHandler);
        console.log(`[GAME] üì• Iframe –∑–∞–≥—Ä—É–∂–µ–Ω (${source}), –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É postMessage...`);
        setTimeout(sendSessionIDMessage, 500);
      };

      iframe.addEventListener('load', loadHandler, { once: true });

      if (iframe.contentWindow) {
        console.log('[GAME] üì• Iframe —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –≤—ã–ø–æ–ª–Ω—è—é postMessage...');
        setTimeout(sendSessionIDMessage, 500);
      }

      setTimeout(() => {
        if (iframe.contentWindow) {
          console.log('[GAME] üì• –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ postMessage (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ iframe)...');
          sendSessionIDMessage();
        }
      }, 1000);

      if (iframe.src) {
        iframe.src = 'about:blank';
        setTimeout(() => {
          iframe.src = resolvedFinalUrl;
          console.log('[GAME] ‚úÖ Iframe src –æ–±–Ω–æ–≤–ª–µ–Ω (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞)');
        }, 10);
      } else {
        iframe.src = resolvedFinalUrl;
        console.log('[GAME] ‚úÖ Iframe src —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
      }

      return true;
    }

    function tryReuseStoredSession() {
      const storedConfig = localStorage.getItem('LAST_CONFIG_URL');
      if (storedConfig) {
        const built = buildSessionFromConfig(storedConfig, 'üì¶ Cached config session');
        if (built) return built;
      }

      const storedIframeUrl = localStorage.getItem('LAST_IFRAME_URL');
      if (storedIframeUrl) {
        try {
          const resolved = new URL(storedIframeUrl, window.location.href);
          const sessionID = resolved.searchParams.get('sessionID') || localStorage.getItem('LAST_SESSION_ID');
          if (!sessionID) return null;
          resolved.searchParams.set('access_token', userToken.accessToken);
          resolved.searchParams.set('_t', Date.now().toString());
          const rgsUrl = resolved.searchParams.get('rgs_url') || localStorage.getItem('LAST_RGS_URL') || '';
          const finalUrl = resolved.pathname + resolved.search;
          return {
            finalUrl,
            baseUrl: finalUrl.split('?')[0],
            sessionID,
            rgsUrl,
            source: 'üìÇ Cached iframe session'
          };
        } catch (err) {
          console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π iframe URL:', err);
        }
      }

      return null;
    }

    async function fetchMirrorFallbackSession() {
      try {
        const response = await fetch('mirrorIndex.json', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error('mirrorIndex.json fetch returned ' + response.status);
        }
        const mirrorMap = await response.json();
        const entry = Object.keys(mirrorMap).find(key => key.includes('sessionID='));
        if (!entry) {
          console.warn('[GAME] ‚ö†Ô∏è –í mirrorIndex.json –Ω–µ –Ω–∞–π–¥–µ–Ω URL —Å sessionID');
          return null;
        }
        const built = buildSessionFromConfig(entry, 'ü™û mirrorIndex session');
        if (built) {
          return built;
        }
      } catch (e) {
        console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å session –∏–∑ mirrorIndex.json:', e);
      }
      return null;
    }

    function applySimpleFallback() {
      const baseUrl = 'mirror/mirror-image-gaming.live.stake-engine.com/drop-the-boss/v10/index.__q_57679522.html';
      console.warn('[GAME] ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π fallback –±–µ–∑ sessionID');
      const params = new URLSearchParams({
        access_token: userToken.accessToken,
        play_for_fun: 'true',
        language: 'en',
        currency: 'USD',
        _t: Date.now().toString()
      });
      iframe.src = `${baseUrl}?${params.toString()}`;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º iframe —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º access_token
    const currentSrc = iframe.src;
    const url = new URL(currentSrc, window.location.href);
    url.searchParams.set('access_token', userToken.accessToken);
    iframe.src = url.toString();
    
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π sessionID –∏–∑ URL —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    try {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('sessionID')) {
        urlParams.delete('sessionID');
        urlParams.delete('rgs_url');
        const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newUrl);
        console.log('[GAME] üóëÔ∏è –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π sessionID –∏–∑ URL —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
      }
    } catch (e) {
      console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å URL:', e);
    }
    
    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π sessionID —á–µ—Ä–µ–∑ GraphQL API
    getNewSessionFromStakeAPI().then(sessionData => {
      console.log('[GAME] ‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π sessionID!');
      const sessionInfo = buildSessionFromConfig(sessionData.fullUrl, 'üåê Stake GraphQL session');
      if (sessionInfo) {
        sessionInfo.currency = sessionData.currency;
        sessionInfo.lang = sessionData.lang;
        prepareIframeWithSession(sessionInfo);
      } else {
        console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã');
        throw new Error('Invalid session config');
      }
    }).catch(async err => {
      console.warn('[GAME] ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å sessionID —á–µ—Ä–µ–∑ API, –∏—â–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:', err);

      const reusedSession = tryReuseStoredSession();
      if (reusedSession) {
        console.log('[GAME] ‚ôªÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é');
        const applied = prepareIframeWithSession(reusedSession);
        if (applied) {
          return;
        }
      }

      const mirrorSession = await fetchMirrorFallbackSession();
      if (mirrorSession) {
        console.log('[GAME] ü™û –ò—Å–ø–æ–ª—å–∑—É–µ–º sessionID –∏–∑ mirrorIndex.json');
        const applied = prepareIframeWithSession(mirrorSession);
        if (applied) {
          return;
        }
      }

      applySimpleFallback();
    });
    
    function resizeIframe() {
      iframe.style.width = window.innerWidth + 'px';
      iframe.style.height = window.innerHeight + 'px';
    }
    
    window.addEventListener('resize', resizeIframe);
    window.addEventListener('load', resizeIframe);
    resizeIframe();
  </script>
</body>
</html>
